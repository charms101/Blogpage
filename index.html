<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Charmi's Diary</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700;900&family=Cinzel:wght@400;600&family=IM+Fell+English:ital@0;1&family=UnifrakturMaguntia&family=Lora:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

:root {
  --gold:       #c9972a;
  --gold-light: #e8b84b;
  --gold-bright:#f5d67a;
  --gold-dark:  #8b6010;
  --paper:      #f5ecd4;
  --paper-aged: #ede0b8;
  --ink:        #1a0e00;
  --green:      #2d5a27;
  --green-dark: #1a3a16;
  --neon:       #39ff14;
}

body {
  min-height: 100vh;
  display: flex; align-items: center; justify-content: center;
  font-family: 'IM Fell English', serif;
  overflow: hidden; position: relative;
  background: #060f08;
}

/* ‚ïê‚ïê GOLDEN GRADIENT BACKGROUND ‚ïê‚ïê */
.bg {
  position: fixed; inset: 0; z-index: 0;
  background:
    radial-gradient(ellipse 70% 60% at 20% 50%, rgba(30,100,60,0.35) 0%, transparent 60%),
    radial-gradient(ellipse 55% 75% at 80% 30%, rgba(201,151,42,0.18) 0%, transparent 55%),
    radial-gradient(ellipse 50% 50% at 55% 85%, rgba(20,80,45,0.22) 0%, transparent 50%),
    radial-gradient(ellipse 80% 40% at 50% 8%,  rgba(201,151,42,0.10) 0%, transparent 55%),
    radial-gradient(ellipse 30% 100% at 0% 50%, rgba(20,80,45,0.15) 0%, transparent 60%),
    radial-gradient(ellipse 30% 100% at 100% 50%, rgba(20,80,45,0.15) 0%, transparent 60%),
    linear-gradient(160deg, #040d07 0%, #060f09 35%, #040d07 65%, #05100a 85%, #030a06 100%);
  pointer-events: none;
}

/* Subtle gold grid */
.bg-grid {
  position: fixed; inset: 0; z-index: 0;
  background-image:
    linear-gradient(rgba(30,100,60,0.06) 1px, transparent 1px),
    linear-gradient(90deg, rgba(30,100,60,0.06) 1px, transparent 1px);
  background-size: 60px 60px;
  pointer-events: none;
}

/* Particles */
.particles { position: fixed; inset: 0; pointer-events: none; z-index: 1; }
.particle { position: absolute; border-radius: 50%; animation: floatUp linear infinite; }
@keyframes floatUp {
  0%   { transform: translateY(110vh); opacity: 0; }
  8%   { opacity: 1; }
  92%  { opacity: 0.5; }
  100% { transform: translateY(-10vh); opacity: 0; }
}

/* ‚ïê‚ïê SCENE ‚ïê‚ïê */
.scene { perspective: 1800px; position: relative; z-index: 2; }

/* ‚ïê‚ïê BOOK ‚ïê‚ïê */
.book {
  width: 820px; height: 540px;
  position: relative; transform-style: preserve-3d;
  filter:
    drop-shadow(0 50px 100px rgba(0,0,0,0.85))
    drop-shadow(0 0 70px rgba(20,120,60,0.3))
    drop-shadow(0 0 40px rgba(201,151,42,0.2))
    drop-shadow(0 0 140px rgba(20,100,50,0.12));
}

/* ‚ïê‚ïê COVER ‚ïê‚ïê */
.cover-wrap {
  position: absolute; inset: 0;
  transform-style: preserve-3d;
  transform-origin: left center;
  transition: transform 1.6s cubic-bezier(0.4, 0.0, 0.2, 1.0);
  z-index: 10;
}
.cover-wrap.open { transform: rotateY(-175deg); }

.cover-front {
  position: absolute; inset: 0;
  backface-visibility: hidden;
  border-radius: 3px 14px 14px 3px;
}
.cover-back-face {
  position: absolute; inset: 0;
  backface-visibility: hidden;
  transform: rotateY(180deg);
  background: var(--paper-aged);
  border-radius: 14px 3px 3px 14px;
  box-shadow: inset 0 0 40px rgba(139,96,16,0.15);
}

/* Deep green cover ‚Äî like Vicar of Wakefield */
.cover-skin {
  width: 100%; height: 100%;
  background:
    radial-gradient(ellipse 80% 60% at 50% 40%, #236650 0%, #1a5040 30%, #143d30 60%, #0f2d23 100%);
  border-radius: 3px 14px 14px 3px;
  position: relative; overflow: hidden;
}

/* Leather grain texture */
.cover-skin::before {
  content: '';
  position: absolute; inset: 0;
  background-image:
    repeating-linear-gradient(47deg, rgba(0,0,0,0.08) 0, rgba(0,0,0,0.08) 1px, transparent 1px, transparent 7px),
    repeating-linear-gradient(-47deg, rgba(255,255,255,0.02) 0, rgba(255,255,255,0.02) 1px, transparent 1px, transparent 7px);
  border-radius: 3px 14px 14px 3px;
}

/* Sheen on green */
.cover-skin::after {
  content: '';
  position: absolute; inset: 0;
  background: linear-gradient(125deg, rgba(255,255,255,0.07) 0%, transparent 45%, rgba(0,0,0,0.2) 100%);
  border-radius: 3px 14px 14px 3px;
  pointer-events: none;
}

/* Spine ‚Äî dark green */
.spine {
  position: absolute; left: 0; top: 0; bottom: 0; width: 26px;
  background: linear-gradient(90deg, #061a12 0%, #0f2d23 50%, #163d30 100%);
  border-right: 1px solid rgba(201,151,42,0.55);
  box-shadow: inset -3px 0 8px rgba(0,0,0,0.4);
}

/* Gold border frame */
.cover-border {
  position: absolute; inset: 16px;
  border: 2px solid var(--gold);
  box-shadow:
    0 0 0 1px rgba(201,151,42,0.3),
    inset 0 0 20px rgba(0,0,0,0.2);
  pointer-events: none;
}
.cover-border::before {
  content: '';
  position: absolute; inset: 7px;
  border: 1px solid rgba(201,151,42,0.55);
}

/* Corner ornaments */
.csq { position: absolute; width: 65px; height: 65px; }
.csq.tl { top: 16px; left: 16px; }
.csq.tr { top: 16px; right: 16px; transform: scaleX(-1); }
.csq.bl { bottom: 16px; left: 16px; transform: scaleY(-1); }
.csq.br { bottom: 16px; right: 16px; transform: scale(-1,-1); }

/* Botanical vines on cover */
.cover-bota { position: absolute; inset: 0; pointer-events: none; }

/* Title block */
.cover-title-wrap {
  position: absolute; top: 50%; left: 50%;
  transform: translate(-50%, -52%);
  text-align: center; width: 54%; z-index: 5;
}
.c-main-title {
  font-family: 'Cinzel Decorative', cursive;
  font-size: 3.1rem; font-weight: 900;
  color: var(--gold-light);
  line-height: 1.12; letter-spacing: 2px;
  text-shadow:
    0 0 30px rgba(201,151,42,0.9),
    0 0 60px rgba(201,151,42,0.4),
    0 2px 6px rgba(0,0,0,0.8);
  animation: titleGlow 4s ease-in-out infinite alternate;
}
@keyframes titleGlow {
  from { text-shadow: 0 0 20px rgba(201,151,42,0.7), 0 2px 6px rgba(0,0,0,0.8); }
  to   { text-shadow: 0 0 40px rgba(245,214,122,1), 0 0 80px rgba(201,151,42,0.5), 0 2px 6px rgba(0,0,0,0.8); }
}
.c-divider {
  width: 80%; margin: 12px auto;
  height: 1.5px;
  background: linear-gradient(90deg, transparent, var(--gold), transparent);
}
.c-byline {
  font-family: 'Cinzel', serif;
  font-size: 0.78rem; color: var(--gold);
  letter-spacing: 4px;
  opacity: 0.88;
}

/* ‚ïê‚ïê PAGES BACKGROUND ‚ïê‚ïê */
.pages-bg {
  position: absolute; inset: 0;
  background: var(--paper);
  border-radius: 3px 14px 14px 3px;
}

/* Page stack illusion on right edge */
.pages-bg::after {
  content: '';
  position: absolute; right: -3px; top: 3px; bottom: 3px; width: 6px;
  background: repeating-linear-gradient(0deg, #e8dbb8, #e8dbb8 1px, #f0e4c0 1px, #f0e4c0 3px);
  border-radius: 0 2px 2px 0;
}

/* ‚ïê‚ïê TWO-PAGE SPREAD (shared base) ‚ïê‚ïê */
.spread, .read-spread {
  position: absolute; inset: 0;
  display: none;
  border-radius: 3px 14px 14px 3px;
  overflow: hidden;
  background: var(--paper);
}
.spread.active, .read-spread.active { display: flex; }

/* Center gutter shadow */
.spread::after, .read-spread::after {
  content: '';
  position: absolute; left: 50%; top: 0; bottom: 0;
  width: 1px;
  background: linear-gradient(180deg,
    transparent 0%,
    rgba(139,96,16,0.12) 10%,
    rgba(139,96,16,0.18) 50%,
    rgba(139,96,16,0.12) 90%,
    transparent 100%);
  box-shadow: -3px 0 8px rgba(0,0,0,0.06), 3px 0 8px rgba(0,0,0,0.06);
  pointer-events: none; z-index: 5;
}

/* Individual pages */
.pg, .rpg {
  flex: 1; position: relative;
  overflow-y: auto; scrollbar-width: none;
}
.pg::-webkit-scrollbar, .rpg::-webkit-scrollbar { display: none; }

/* Warm aged paper gradient per page */
.pg, .rpg {
  background: linear-gradient(180deg, #f8f0d8 0%, #f3e8c8 40%, #f0e4c0 100%);
}
.pg { padding: 44px 36px 28px 44px; }
.pg.right { padding: 44px 44px 28px 36px; }
.rpg { padding: 40px 32px 28px 44px; }
.rpg.right { padding: 40px 44px 28px 32px; }

/* Subtle lined paper */
.pg::before, .rpg::before {
  content: '';
  position: absolute; inset: 0;
  background: repeating-linear-gradient(
    0deg, transparent, transparent 29px,
    rgba(139,96,16,0.07) 29px, rgba(139,96,16,0.07) 30px
  );
  pointer-events: none; z-index: 0;
}

/* Left margin red line */
.pg::after {
  content: '';
  position: absolute; left: 58px; top: 0; bottom: 0; width: 1px;
  background: rgba(200,80,80,0.2);
  pointer-events: none;
}
.rpg::after {
  content: '';
  position: absolute; left: 58px; top: 0; bottom: 0; width: 1px;
  background: rgba(200,80,80,0.2);
  pointer-events: none;
}
.pg.right::after, .rpg.right::after { display: none; }

/* Make content sit above the lines */
.pg > *, .rpg > * { position: relative; z-index: 1; }

/* ‚ïê‚ïê TOC ‚ïê‚ïê */
.toc-head {
  font-family: 'Cinzel Decorative', cursive;
  font-size: 1.05rem; color: #4a2c00;
  text-align: center; margin-bottom: 6px;
  letter-spacing: 1px;
}
.toc-rule {
  width: 90%; margin: 0 auto 24px;
  height: 1px;
  background: linear-gradient(90deg, transparent, var(--gold), transparent);
  opacity: 0.8;
}
.toc-row {
  display: flex; align-items: center; gap: 0;
  margin-bottom: 0; cursor: pointer;
  padding: 9px 8px; border-radius: 3px;
  transition: background 0.25s;
  opacity: 0; transform: translateX(10px);
  border-bottom: 1px solid rgba(201,151,42,0.1);
}
.toc-row:last-child { border-bottom: none; }
.toc-row.show { animation: rowIn 0.4s ease forwards; }
@keyframes rowIn { to { opacity: 1; transform: translateX(0); } }
.toc-row:hover { background: rgba(201,151,42,0.08); }
.toc-row:hover .toc-rname { color: #4a2c00; }
.toc-rnum {
  font-family: 'Cinzel', serif; font-size: 0.65rem;
  color: var(--gold-dark); min-width: 26px; flex-shrink: 0;
}
.toc-rname {
  font-family: 'Lora', serif; font-size: 0.9rem;
  font-style: italic; color: var(--ink); flex: 1;
  transition: color 0.25s;
}
.toc-rdots {
  flex: 1; border-bottom: 1px dotted rgba(0,0,0,0.18);
  margin: 0 8px; margin-bottom: 2px; min-width: 20px; max-width: 60px;
}
.toc-rpg {
  font-family: 'Cinzel', serif; font-size: 0.6rem;
  color: rgba(0,0,0,0.3);
}

/* TOC right page deco */
.toc-deco {
  width: 100%; height: 100%;
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  opacity: 0.3;
}

/* ‚ïê‚ïê READING PAGE ‚ïê‚ïê */
.r-chapter-title {
  font-family: 'Cinzel Decorative', cursive;
  font-size: 0.95rem; color: #4a2c00;
  margin-bottom: 4px; text-align: center;
}
.r-rule {
  width: 80%; margin: 0 auto 18px;
  height: 1px;
  background: linear-gradient(90deg, transparent, var(--gold), transparent);
  opacity: 0.7;
}
.r-text {
  font-family: 'Lora', serif;
  font-size: 0.92rem; line-height: 2.05;
  color: var(--ink); text-align: justify;
}
.r-text p {
  margin-bottom: 14px;
  opacity: 0; transform: translateY(6px);
  animation: pIn 0.5s ease forwards;
}
@keyframes pIn { to { opacity: 1; transform: translateY(0); } }

/* Beautiful drop cap */
.drop-cap::first-letter {
  font-family: 'UnifrakturMaguntia', cursive;
  font-size: 5rem; float: left;
  line-height: 0.6; margin: 10px 10px 0 0;
  color: #4a2c00;
  text-shadow: 1px 1px 0 var(--gold), 2px 2px 4px rgba(0,0,0,0.2);
}

/* ‚ïê‚ïê BOTTOM BAR ‚Äî clean, only Comment button ‚ïê‚ïê */
.page-bottom {
  position: absolute; bottom: 0; left: 0; right: 0;
  height: 48px;
  display: flex; align-items: center; justify-content: center;
  background: linear-gradient(180deg, transparent 0%, rgba(243,232,200,0.95) 40%);
  border-top: 1px solid rgba(201,151,42,0.15);
}

/* Back button ‚Äî left page only, very subtle */
.r-back-btn {
  position: absolute; left: 44px;
  font-family: 'Cinzel', serif; font-size: 0.58rem;
  color: rgba(139,96,16,0.55); cursor: pointer;
  letter-spacing: 2px; text-transform: uppercase;
  background: none; border: none; transition: color 0.25s;
}
.r-back-btn:hover { color: var(--gold-dark); }

/* Comment button ‚Äî right page only, centered at bottom */
.r-comment-btn {
  font-family: 'Cinzel', serif;
  font-size: 0.7rem; letter-spacing: 2px;
  color: #4a2c00;
  background: linear-gradient(135deg, rgba(201,151,42,0.22), rgba(201,151,42,0.10));
  border: 1.5px solid rgba(201,151,42,0.5);
  border-radius: 30px;
  padding: 7px 22px;
  cursor: pointer;
  transition: all 0.3s;
  white-space: nowrap;
}
.r-comment-btn:hover {
  background: linear-gradient(135deg, rgba(201,151,42,0.38), rgba(201,151,42,0.22));
  border-color: var(--gold);
  transform: translateY(-2px);
  box-shadow: 0 6px 18px rgba(201,151,42,0.25);
}

/* ‚ïê‚ïê COMMENT OVERLAY ‚ïê‚ïê */
.overlay {
  display: none; position: fixed; inset: 0;
  background: rgba(20,11,0,0.88); z-index: 100;
  align-items: center; justify-content: center;
  backdrop-filter: blur(8px);
}
.overlay.active { display: flex; animation: fadeIn 0.35s ease; }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

.c-card {
  background: var(--paper);
  border: 2px solid var(--gold);
  border-radius: 12px; padding: 40px; width: 460px; max-width: 92vw;
  box-shadow:
    0 0 80px rgba(201,151,42,0.25),
    0 0 160px rgba(201,151,42,0.10),
    0 30px 80px rgba(0,0,0,0.7);
  animation: cardUp 0.5s cubic-bezier(0.34,1.56,0.64,1);
}
@keyframes cardUp { from { transform: translateY(20px) scale(0.96); opacity: 0; } to { transform: none; opacity: 1; } }

.c-title {
  font-family: 'Cinzel Decorative', cursive;
  font-size: 1rem; color: #4a2c00; text-align: center; margin-bottom: 5px;
}
.c-sub {
  font-family: 'Lora', serif; font-style: italic;
  font-size: 0.84rem; color: rgba(0,0,0,0.42); text-align: center; margin-bottom: 18px;
}
.c-hr { height: 1px; background: linear-gradient(90deg, transparent, var(--gold), transparent); margin-bottom: 18px; }
.c-name-in, .c-text-in {
  width: 100%;
  background: rgba(255,255,255,0.6);
  border: 1px solid rgba(201,151,42,0.38); border-radius: 5px;
  font-family: 'Lora', serif; font-size: 0.88rem; color: var(--ink);
  outline: none; transition: border-color 0.3s;
}
.c-name-in { padding: 10px 13px; margin-bottom: 11px; display: block; }
.c-text-in { padding: 11px 13px; height: 90px; resize: none; display: block; }
.c-name-in:focus, .c-text-in:focus { border-color: var(--gold); background: rgba(255,255,255,0.8); }
.c-btn {
  width: 100%; margin-top: 14px; padding: 12px;
  background: linear-gradient(135deg, #4a2c00, #2e1a00);
  border: 1px solid var(--gold); border-radius: 6px;
  color: var(--gold-light); font-family: 'Cinzel', serif;
  font-size: 0.75rem; letter-spacing: 3px; cursor: pointer; transition: all 0.3s;
}
.c-btn:hover { box-shadow: 0 0 25px rgba(201,151,42,0.3); transform: translateY(-1px); }
.c-ty { display: none; text-align: center; padding: 20px 0; }
.c-ty.show { display: block; }
.c-seal { font-size: 2.8rem; margin-bottom: 10px; animation: sealPop 0.5s cubic-bezier(0.34,1.56,0.64,1); }
@keyframes sealPop { from { transform: scale(0) rotate(-20deg); } to { transform: scale(1) rotate(0deg); } }

/* ‚ïê‚ïê WRITER PANEL ‚ïê‚ïê */
.writer-panel {
  display: none; position: fixed; inset: 0;
  background: rgba(15,8,0,0.93); z-index: 200;
  align-items: center; justify-content: center;
  backdrop-filter: blur(10px);
}
.writer-panel.active { display: flex; animation: fadeIn 0.35s ease; }

.w-modal {
  background: #1a0e00; border: 2px solid rgba(201,151,42,0.4);
  border-radius: 14px; width: 700px; max-width: 95vw; max-height: 92vh;
  overflow-y: auto; scrollbar-width: thin; scrollbar-color: rgba(201,151,42,0.3) transparent;
  box-shadow: 0 0 80px rgba(201,151,42,0.18), 0 40px 100px rgba(0,0,0,0.9);
}
.w-head {
  padding: 26px 30px 18px; border-bottom: 1px solid rgba(201,151,42,0.15);
  display: flex; justify-content: space-between; align-items: center;
  position: sticky; top: 0; background: #1a0e00; z-index: 5;
}
.w-title { font-family: 'Cinzel Decorative', cursive; font-size: 1rem; color: var(--gold-light); text-shadow: 0 0 20px rgba(201,151,42,0.4); }
.w-badge {
  display: inline-flex; align-items: center;
  background: rgba(201,151,42,0.1); border: 1px solid rgba(201,151,42,0.3);
  border-radius: 20px; padding: 2px 10px; margin-left: 10px;
  font-family: 'Cinzel', serif; font-size: 0.52rem; letter-spacing: 2px; color: var(--gold);
}
.w-close { background: none; border: none; color: rgba(201,151,42,0.5); font-size: 1.3rem; cursor: pointer; transition: color 0.2s; }
.w-close:hover { color: var(--gold-light); }
.w-body { padding: 26px 30px 30px; }

/* Tabs */
.w-tabs { display: flex; gap: 4px; margin-bottom: 22px; border-bottom: 1px solid rgba(201,151,42,0.15); }
.w-tab {
  font-family: 'Cinzel', serif; font-size: 0.68rem; letter-spacing: 2px;
  color: rgba(201,151,42,0.4); padding: 8px 16px; cursor: pointer;
  border-radius: 6px 6px 0 0; transition: all 0.25s;
  border: 1px solid transparent; border-bottom: none;
  margin-bottom: -1px; background: transparent;
}
.w-tab.active { color: var(--gold-light); border-color: rgba(201,151,42,0.25); background: rgba(201,151,42,0.06); }
.w-panel { display: none; }
.w-panel.active { display: block; }

/* Form */
.w-lbl { font-family: 'Cinzel', serif; font-size: 0.6rem; letter-spacing: 2px; color: rgba(201,151,42,0.6); text-transform: uppercase; margin-bottom: 6px; display: block; }
.w-in {
  width: 100%; background: rgba(255,255,255,0.04); border: 1px solid rgba(201,151,42,0.2);
  border-radius: 6px; color: #e8dfc0; font-family: 'Lora', serif; font-size: 0.88rem;
  padding: 10px 13px; outline: none; transition: border-color 0.3s; margin-bottom: 16px;
}
.w-in:focus { border-color: rgba(201,151,42,0.5); }
.w-ta {
  width: 100%; background: rgba(255,255,255,0.04); border: 1px solid rgba(201,151,42,0.2);
  border-radius: 6px; color: #e8dfc0; font-family: 'Lora', serif; font-size: 0.88rem;
  line-height: 1.85; padding: 13px; outline: none; resize: vertical; min-height: 200px;
  transition: border-color 0.3s; margin-bottom: 16px; display: block;
}
.w-ta:focus { border-color: rgba(201,151,42,0.5); }
.w-toolbar { display: flex; gap: 6px; margin-bottom: 9px; flex-wrap: wrap; }
.w-tool {
  padding: 5px 11px; background: rgba(255,255,255,0.03);
  border: 1px solid rgba(201,151,42,0.16); border-radius: 4px;
  color: rgba(201,151,42,0.6); font-size: 0.7rem;
  cursor: pointer; font-family: 'Cinzel', serif; transition: all 0.2s;
}
.w-tool:hover { background: rgba(201,151,42,0.1); color: var(--gold-light); }
.w-hint { font-family: 'Lora', serif; font-style: italic; font-size: 0.75rem; color: rgba(201,151,42,0.35); margin-top: -10px; margin-bottom: 16px; }
.w-publish {
  width: 100%; padding: 13px;
  background: linear-gradient(135deg, #4a2c00, #2e1a00);
  border: 1px solid var(--gold); border-radius: 6px;
  color: var(--gold-light); font-family: 'Cinzel', serif;
  font-size: 0.77rem; letter-spacing: 3px; cursor: pointer; transition: all 0.3s;
}
.w-publish:hover { box-shadow: 0 0 25px rgba(201,151,42,0.25); transform: translateY(-1px); }

/* Cards */
.w-cards { display: flex; flex-direction: column; gap: 10px; }
.w-ccard {
  background: rgba(255,255,255,0.03); border: 1px solid rgba(201,151,42,0.15);
  border-radius: 8px; padding: 14px 16px;
  display: flex; justify-content: space-between; align-items: center;
  transition: border-color 0.25s;
}
.w-ccard:hover { border-color: rgba(201,151,42,0.35); }
.w-ccard-title { font-family: 'Lora', serif; font-style: italic; font-size: 0.9rem; color: #e8dfc0; }
.w-ccard-meta { font-family: 'Cinzel', serif; font-size: 0.57rem; color: rgba(201,151,42,0.42); letter-spacing: 1px; margin-top: 4px; }
.w-actions { display: flex; gap: 7px; }
.w-act { padding: 5px 10px; border-radius: 4px; font-family: 'Cinzel', serif; font-size: 0.57rem; letter-spacing: 1px; cursor: pointer; border: none; transition: all 0.2s; }
.w-act.ed { background: rgba(201,151,42,0.12); color: var(--gold); }
.w-act.ed:hover { background: rgba(201,151,42,0.22); }
.w-act.dl { background: rgba(180,40,40,0.12); color: #e88; }
.w-act.dl:hover { background: rgba(180,40,40,0.22); }
.w-empty { font-family: 'Lora', serif; font-style: italic; color: rgba(201,151,42,0.3); text-align: center; padding: 30px 0; font-size: 0.86rem; }

/* Comment cards */
.w-comment-card {
  background: rgba(255,255,255,0.03); border: 1px solid rgba(201,151,42,0.15);
  border-radius: 8px; padding: 14px 16px; margin-bottom: 10px;
  transition: border-color 0.25s opacity 0.3s;
}
.w-comment-card:hover { border-color: rgba(201,151,42,0.35); }
.w-comment-meta { display: flex; justify-content: space-between; align-items: center; margin-bottom: 7px; }
.w-comment-author { font-family: 'Cinzel', serif; font-size: 0.65rem; color: var(--gold); letter-spacing: 1px; }
.w-comment-chapter { font-family: 'Cinzel', serif; font-size: 0.56rem; color: rgba(201,151,42,0.38); }
.w-comment-text { font-family: 'Lora', serif; font-style: italic; font-size: 0.83rem; color: #c8bfa0; line-height: 1.6; margin-bottom: 9px; }
.w-comment-footer { display: flex; justify-content: flex-end; }

/* Secret flash */
.secret-flash {
  position: fixed; top: 22px; left: 50%; transform: translateX(-50%);
  background: rgba(26,14,0,0.96); border: 1px solid rgba(201,151,42,0.45);
  border-radius: 8px; padding: 10px 24px;
  font-family: 'Cinzel', serif; font-size: 0.66rem; letter-spacing: 2px;
  color: var(--gold-light); z-index: 300;
  opacity: 0; transition: opacity 0.4s;
  box-shadow: 0 0 20px rgba(201,151,42,0.2);
  pointer-events: none;
}
.secret-flash.show { opacity: 1; }

/* Toast */
.toast {
  position: fixed; bottom: 28px; left: 50%; transform: translateX(-50%) translateY(60px);
  background: #2e1a00; border: 1px solid var(--gold);
  border-radius: 8px; padding: 11px 22px;
  font-family: 'Cinzel', serif; font-size: 0.68rem; letter-spacing: 2px;
  color: var(--gold-light); z-index: 400;
  box-shadow: 0 0 20px rgba(201,151,42,0.2);
  transition: transform 0.4s cubic-bezier(0.34,1.56,0.64,1);
}
.toast.show { transform: translateX(-50%) translateY(0); }

/* Confetti */
@keyframes confFall {
  0%   { transform: translateY(-10px) rotate(0deg); opacity: 1; }
  100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
}
</style>
</head>
<body>

<div class="bg"></div>
<div class="bg-grid"></div>
<div class="particles" id="particles"></div>

<div class="scene">
  <div class="book" id="book">

    <!-- Pages bg -->
    <div class="pages-bg"></div>

    <!-- TOC SPREAD -->
    <div class="spread" id="tocSpread">
      <div class="pg">
        <div class="toc-head">Table of Contents</div>
        <div class="toc-rule"></div>
        <div id="tocList"></div>
      </div>
      <div class="pg right">
        <div class="toc-deco">
          <svg width="140" height="180" viewBox="0 0 140 180" fill="none">
            <path d="M70 170 C70 170 70 90 70 15" stroke="#8b6010" stroke-width="1.8" fill="none"/>
            <path d="M70 140 C70 140 34 116 12 88" stroke="#8b6010" stroke-width="1.2" fill="none"/>
            <path d="M70 112 C70 112 102 95 122 70" stroke="#8b6010" stroke-width="1.2" fill="none"/>
            <path d="M70 84 C70 84 38 65 20 42" stroke="#8b6010" stroke-width="1.2" fill="none"/>
            <path d="M70 58 C70 58 96 44 115 26" stroke="#8b6010" stroke-width="1.2" fill="none"/>
            <ellipse cx="10" cy="86" rx="11" ry="6.5" fill="#8b6010" transform="rotate(-30 10 86)" opacity="0.7"/>
            <ellipse cx="123" cy="68" rx="11" ry="6.5" fill="#8b6010" transform="rotate(24 123 68)" opacity="0.7"/>
            <ellipse cx="18" cy="40" rx="10" ry="6" fill="#8b6010" transform="rotate(-40 18 40)" opacity="0.7"/>
            <ellipse cx="116" cy="24" rx="10" ry="6" fill="#8b6010" transform="rotate(18 116 24)" opacity="0.7"/>
            <circle cx="70" cy="15" r="5.5" fill="#c9972a" opacity="0.9"/>
            <circle cx="70" cy="170" r="4" fill="#8b6010" opacity="0.6"/>
            <circle cx="70" cy="84" r="2.5" fill="#c9972a" opacity="0.55"/>
            <circle cx="70" cy="112" r="1.5" fill="#c9972a" opacity="0.4"/>
          </svg>
          <p style="font-family:'Cinzel',serif;font-size:0.62rem;color:#8b6010;letter-spacing:3px;margin-top:20px;opacity:0.7;">Est. 2026</p>
        </div>
      </div>
    </div>

    <!-- READING SPREAD -->
    <div class="read-spread" id="readSpread">
      <!-- Left page: text + back button at bottom -->
      <div class="rpg">
        <div class="r-chapter-title" id="rTitle"></div>
        <div class="r-rule"></div>
        <div class="r-text" id="rTextLeft"></div>
        <div class="page-bottom">
          <button class="r-back-btn" onclick="backToTOC()">‚Üê Contents</button>
        </div>
      </div>
      <!-- Right page: text + comment button at bottom -->
      <div class="rpg right">
        <div class="r-text" id="rTextRight"></div>
        <div class="page-bottom">
          <button class="r-comment-btn" onclick="document.getElementById('commentOverlay').classList.add('active')">Comment ‚ô•</button>
        </div>
      </div>
    </div>

    <!-- COVER -->
    <div class="cover-wrap" id="coverWrap">
      <div class="cover-front">
        <div class="cover-skin">
          <div class="spine"></div>
          <div class="cover-border"></div>

          <!-- Corner ornaments ‚Äî bright gold on green like Vicar of Wakefield -->
          <svg class="csq tl" viewBox="0 0 65 65" fill="none">
            <path d="M4 4L4 61" stroke="#c9972a" stroke-width="1.8"/>
            <path d="M4 4L61 4" stroke="#c9972a" stroke-width="1.8"/>
            <circle cx="4" cy="4" r="4" fill="#c9972a"/>
            <circle cx="4" cy="4" r="2" fill="#f5d67a"/>
            <path d="M13 4 C13 22 28 32 46 30" stroke="#c9972a" stroke-width="1.3" fill="none"/>
            <ellipse cx="50" cy="29" rx="9" ry="5.5" fill="#c9972a" transform="rotate(22 50 29)"/>
            <ellipse cx="50" cy="29" rx="5" ry="2.8" fill="#e8b84b" transform="rotate(22 50 29)"/>
            <path d="M4 13 C22 13 32 28 30 46" stroke="#c9972a" stroke-width="1.3" fill="none"/>
            <ellipse cx="29" cy="50" rx="9" ry="5.5" fill="#c9972a" transform="rotate(68 29 50)"/>
            <ellipse cx="29" cy="50" rx="5" ry="2.8" fill="#e8b84b" transform="rotate(68 29 50)"/>
            <!-- Small decorative fan at corner -->
            <path d="M4 4 C14 8 18 14 16 22" stroke="#c9972a" stroke-width="0.8" fill="none" opacity="0.6"/>
            <path d="M4 4 C8 14 14 18 22 16" stroke="#c9972a" stroke-width="0.8" fill="none" opacity="0.6"/>
          </svg>
          <svg class="csq tr" viewBox="0 0 65 65" fill="none">
            <path d="M4 4L4 61" stroke="#c9972a" stroke-width="1.8"/>
            <path d="M4 4L61 4" stroke="#c9972a" stroke-width="1.8"/>
            <circle cx="4" cy="4" r="4" fill="#c9972a"/>
            <circle cx="4" cy="4" r="2" fill="#f5d67a"/>
            <path d="M13 4 C13 22 28 32 46 30" stroke="#c9972a" stroke-width="1.3" fill="none"/>
            <ellipse cx="50" cy="29" rx="9" ry="5.5" fill="#c9972a" transform="rotate(22 50 29)"/>
            <ellipse cx="50" cy="29" rx="5" ry="2.8" fill="#e8b84b" transform="rotate(22 50 29)"/>
            <path d="M4 13 C22 13 32 28 30 46" stroke="#c9972a" stroke-width="1.3" fill="none"/>
            <ellipse cx="29" cy="50" rx="9" ry="5.5" fill="#c9972a" transform="rotate(68 29 50)"/>
            <ellipse cx="29" cy="50" rx="5" ry="2.8" fill="#e8b84b" transform="rotate(68 29 50)"/>
            <path d="M4 4 C14 8 18 14 16 22" stroke="#c9972a" stroke-width="0.8" fill="none" opacity="0.6"/>
            <path d="M4 4 C8 14 14 18 22 16" stroke="#c9972a" stroke-width="0.8" fill="none" opacity="0.6"/>
          </svg>
          <svg class="csq bl" viewBox="0 0 65 65" fill="none">
            <path d="M4 4L4 61" stroke="#c9972a" stroke-width="1.8"/>
            <path d="M4 4L61 4" stroke="#c9972a" stroke-width="1.8"/>
            <circle cx="4" cy="4" r="4" fill="#c9972a"/>
            <circle cx="4" cy="4" r="2" fill="#f5d67a"/>
            <path d="M13 4 C13 22 28 32 46 30" stroke="#c9972a" stroke-width="1.3" fill="none"/>
            <ellipse cx="50" cy="29" rx="9" ry="5.5" fill="#c9972a" transform="rotate(22 50 29)"/>
            <path d="M4 13 C22 13 32 28 30 46" stroke="#c9972a" stroke-width="1.3" fill="none"/>
            <ellipse cx="29" cy="50" rx="9" ry="5.5" fill="#c9972a" transform="rotate(68 29 50)"/>
          </svg>
          <svg class="csq br" viewBox="0 0 65 65" fill="none">
            <path d="M4 4L4 61" stroke="#c9972a" stroke-width="1.8"/>
            <path d="M4 4L61 4" stroke="#c9972a" stroke-width="1.8"/>
            <circle cx="4" cy="4" r="4" fill="#c9972a"/>
            <circle cx="4" cy="4" r="2" fill="#f5d67a"/>
            <path d="M13 4 C13 22 28 32 46 30" stroke="#c9972a" stroke-width="1.3" fill="none"/>
            <ellipse cx="50" cy="29" rx="9" ry="5.5" fill="#c9972a" transform="rotate(22 50 29)"/>
            <path d="M4 13 C22 13 32 28 30 46" stroke="#c9972a" stroke-width="1.3" fill="none"/>
            <ellipse cx="29" cy="50" rx="9" ry="5.5" fill="#c9972a" transform="rotate(68 29 50)"/>
          </svg>

          <!-- Vicar of Wakefield-style botanical vines ‚Äî bright gold on green -->
          <svg class="cover-bota" viewBox="0 0 820 540" preserveAspectRatio="none">
            <!-- Left main vine -->
            <path d="M90 525 C90 525 68 400 95 285 C122 170 84 88 108 28" stroke="#b8860b" stroke-width="2.8" fill="none"/>
            <path d="M90 525 C90 525 68 400 95 285 C122 170 84 88 108 28" stroke="rgba(201,151,42,0.35)" stroke-width="1.5" fill="none" transform="translate(1,1)"/>
            <!-- Left branches -->
            <path d="M92 455 C92 455 52 430 30 398" stroke="#c9972a" stroke-width="1.8" fill="none"/>
            <ellipse cx="24" cy="394" rx="20" ry="12" fill="#c9972a" transform="rotate(-28 24 394)"/>
            <ellipse cx="24" cy="394" rx="12" ry="7" fill="rgba(245,214,122,0.45)" transform="rotate(-28 24 394)"/>
            <ellipse cx="15" cy="386" rx="10" ry="6" fill="rgba(201,151,42,0.72)" transform="rotate(-18 15 386)"/>

            <path d="M93 375 C93 375 138 352 160 320" stroke="#c9972a" stroke-width="1.8" fill="none"/>
            <ellipse cx="164" cy="316" rx="19" ry="11" fill="#c9972a" transform="rotate(20 164 316)"/>
            <ellipse cx="164" cy="316" rx="11" ry="6" fill="rgba(245,214,122,0.45)" transform="rotate(20 164 316)"/>
            <ellipse cx="173" cy="308" rx="9" ry="5.5" fill="rgba(201,151,42,0.68)" transform="rotate(30 173 308)"/>

            <path d="M94 288 C94 288 52 264 32 232" stroke="#c9972a" stroke-width="1.8" fill="none"/>
            <ellipse cx="27" cy="228" rx="19" ry="11" fill="#c9972a" transform="rotate(-33 27 228)"/>
            <ellipse cx="27" cy="228" rx="11" ry="6" fill="rgba(245,214,122,0.45)" transform="rotate(-33 27 228)"/>

            <path d="M95 202 C95 202 140 180 162 150" stroke="#c9972a" stroke-width="1.8" fill="none"/>
            <ellipse cx="165" cy="146" rx="18" ry="10" fill="#c9972a" transform="rotate(22 165 146)"/>
            <ellipse cx="165" cy="146" rx="10" ry="5.5" fill="rgba(245,214,122,0.45)" transform="rotate(22 165 146)"/>

            <path d="M97 122 C97 122 62 100 57 62" stroke="#c9972a" stroke-width="1.8" fill="none"/>
            <ellipse cx="54" cy="58" rx="16" ry="9" fill="#c9972a" transform="rotate(-12 54 58)"/>
            <ellipse cx="54" cy="58" rx="9" ry="5" fill="rgba(245,214,122,0.45)" transform="rotate(-12 54 58)"/>

            <!-- Right main vine -->
            <path d="M730 515 C730 515 758 385 738 262 C718 140 762 62 744 22" stroke="#b8860b" stroke-width="2.8" fill="none"/>
            <path d="M730 515 C730 515 758 385 738 262 C718 140 762 62 744 22" stroke="rgba(201,151,42,0.35)" stroke-width="1.5" fill="none" transform="translate(-1,1)"/>
            <!-- Right branches -->
            <path d="M732 448 C732 448 772 424 792 392" stroke="#c9972a" stroke-width="1.8" fill="none"/>
            <ellipse cx="796" cy="388" rx="20" ry="12" fill="#c9972a" transform="rotate(25 796 388)"/>
            <ellipse cx="796" cy="388" rx="12" ry="7" fill="rgba(245,214,122,0.45)" transform="rotate(25 796 388)"/>

            <path d="M734 360 C734 360 692 336 675 304" stroke="#c9972a" stroke-width="1.8" fill="none"/>
            <ellipse cx="671" cy="300" rx="19" ry="11" fill="#c9972a" transform="rotate(-22 671 300)"/>
            <ellipse cx="671" cy="300" rx="11" ry="6" fill="rgba(245,214,122,0.45)" transform="rotate(-22 671 300)"/>

            <path d="M736 275 C736 275 775 254 794 222" stroke="#c9972a" stroke-width="1.8" fill="none"/>
            <ellipse cx="797" cy="218" rx="18" ry="10" fill="#c9972a" transform="rotate(28 797 218)"/>
            <ellipse cx="797" cy="218" rx="10" ry="5.5" fill="rgba(245,214,122,0.45)" transform="rotate(28 797 218)"/>

            <path d="M737 188 C737 188 695 165 680 132" stroke="#c9972a" stroke-width="1.8" fill="none"/>
            <ellipse cx="676" cy="128" rx="19" ry="11" fill="#c9972a" transform="rotate(-25 676 128)"/>
            <ellipse cx="676" cy="128" rx="11" ry="6" fill="rgba(245,214,122,0.45)" transform="rotate(-25 676 128)"/>

            <!-- Bottom scrollwork -->
            <path d="M205 518 C240 494 278 504 300 480 C322 456 340 470 372 448 C404 426 432 488 468 502" stroke="rgba(201,151,42,0.8)" stroke-width="1.8" fill="none"/>
            <path d="M205 518 C240 494 278 504 300 480 C322 456 340 470 372 448 C404 426 432 488 468 502" stroke="rgba(201,151,42,0.3)" stroke-width="1" fill="none" transform="translate(0.5,0.5)"/>
            <path d="M468 502 C504 480 535 492 558 468 C581 444 596 460 635 498" stroke="rgba(201,151,42,0.8)" stroke-width="1.8" fill="none"/>

            <!-- Centre bottom spiral -->
            <path d="M410 525 C410 525 376 500 386 476 C396 452 418 458 422 440 C426 422 406 414 402 398 C398 382 412 375 410 360" stroke="rgba(201,151,42,0.72)" stroke-width="1.4" fill="none"/>
            <path d="M410 525 C410 525 376 500 386 476 C396 452 418 458 422 440 C426 422 406 414 402 398" stroke="rgba(201,151,42,0.28)" stroke-width="0.8" fill="none" transform="translate(0.5,0.5)"/>

            <!-- Embossed star accents -->
            <circle cx="170" cy="238" r="3.5" fill="#c9972a"/>
            <circle cx="170" cy="238" r="2" fill="#f5d67a"/>
            <circle cx="177" cy="226" r="1.5" fill="rgba(201,151,42,0.85)"/>
            <circle cx="161" cy="230" r="1.5" fill="rgba(201,151,42,0.85)"/>

            <circle cx="654" cy="170" r="3.5" fill="#c9972a"/>
            <circle cx="654" cy="170" r="2" fill="#f5d67a"/>
            <circle cx="661" cy="158" r="1.5" fill="rgba(201,151,42,0.85)"/>
            <circle cx="645" cy="162" r="1.5" fill="rgba(201,151,42,0.85)"/>

            <!-- Bottom leaf clusters -->
            <ellipse cx="250" cy="514" rx="12" ry="7" fill="rgba(201,151,42,0.8)" transform="rotate(-38 250 514)"/>
            <ellipse cx="580" cy="508" rx="12" ry="7" fill="rgba(201,151,42,0.8)" transform="rotate(32 580 508)"/>
            <ellipse cx="415" cy="360" rx="8" ry="5" fill="rgba(201,151,42,0.68)" transform="rotate(10 415 360)"/>
          </svg>

          <!-- Title -->
          <div class="cover-title-wrap">
            <div class="c-main-title">Charmi's<br>Diary</div>
            <div class="c-divider"></div>
            <div class="c-byline">A Personal Collection</div>
          </div>
        </div>
      </div>
      <div class="cover-back-face"></div>
    </div>

  </div>
</div>

<!-- Comment Overlay -->
<div class="overlay" id="commentOverlay">
  <div class="c-card">
    <div id="cForm">
      <div class="c-title">Leave a Thought</div>
      <div class="c-sub">I would love to know what you felt ‚ú®</div>
      <div class="c-hr"></div>
      <input class="c-name-in" type="text" id="cName" placeholder="Your name..."/>
      <textarea class="c-text-in" id="cText" placeholder="Write your thoughts here..."></textarea>
      <button class="c-btn" onclick="submitComment()">SEAL & SEND</button>
    </div>
    <div class="c-ty" id="cTy">
      <div class="c-seal">üïØÔ∏è</div>
      <div class="c-title">Thank you, dear reader</div>
      <p style="font-family:'Lora',serif;font-style:italic;color:rgba(0,0,0,0.46);margin-top:10px;font-size:0.84rem;">Your words have been received with gratitude.</p>
    </div>
  </div>
</div>

<!-- Writer Panel (secret ‚Äî type "charmi") -->
<div class="writer-panel" id="writerPanel">
  <div class="w-modal">
    <div class="w-head">
      <span class="w-title">Writer's Studio <span class="w-badge">üîí AUTHOR ONLY</span></span>
      <button class="w-close" onclick="closeWriter()">‚úï</button>
    </div>
    <div class="w-body">
      <div class="w-tabs">
        <button class="w-tab active" id="tab-btn-write"    onclick="switchTab('write',this)">‚úí Write</button>
        <button class="w-tab"        id="tab-btn-chapters" onclick="switchTab('chapters',this)">üìñ Chapters</button>
        <button class="w-tab"        id="tab-btn-comments" onclick="switchTab('comments',this)">üí¨ Comments</button>
      </div>

      <!-- Write -->
      <div class="w-panel active" id="tab-write">
        <label class="w-lbl">Chapter Title</label>
        <input class="w-in" type="text" id="wTitle" placeholder="e.g. The Morning I Forgot My Name"/>
        <label class="w-lbl">Your Entry</label>
        <div class="w-toolbar">
          <button class="w-tool" onclick="wWrap('**','**')">Bold</button>
          <button class="w-tool" onclick="wWrap('_','_')">Italic</button>
          <button class="w-tool" onclick="wBreak()">¬∂ New Para</button>
          <button class="w-tool" onclick="wIns('‚ú¶')">‚ú¶ Divider</button>
        </div>
        <textarea class="w-ta" id="wContent" placeholder="Begin writing here...&#10;&#10;Separate paragraphs with a blank line.&#10;Your opening paragraph gets a decorative drop cap."></textarea>
        <p class="w-hint">Tip ‚Äî blank line between paragraphs. First paragraph gets a drop cap automatically.</p>
        <label class="w-lbl">Chapter Number (leave blank for next)</label>
        <input class="w-in" type="number" id="wNum" placeholder="e.g. 1, 2, 3..."/>
        <button class="w-publish" onclick="publishChapter()">PUBLISH TO DIARY</button>
      </div>

      <!-- Chapters -->
      <div class="w-panel" id="tab-chapters">
        <div class="w-cards" id="wCards"></div>
      </div>

      <!-- Comments -->
      <div class="w-panel" id="tab-comments">
        <div id="wComments"></div>
      </div>
    </div>
  </div>
</div>

<div class="secret-flash" id="secretFlash">‚ú¶ WRITER'S STUDIO UNLOCKED</div>
<div class="toast" id="toast"></div>

<script>
// ‚îÄ‚îÄ PARTICLES ‚îÄ‚îÄ
const pEl = document.getElementById('particles');
const pCols = ['rgba(201,151,42,0.85)','rgba(57,180,80,0.6)','rgba(245,214,122,0.65)','rgba(30,150,70,0.5)','rgba(232,184,75,0.7)'];
for (let i = 0; i < 35; i++) {
  const p = document.createElement('div');
  p.className = 'particle';
  const s = 1 + Math.random() * 2.5;
  p.style.cssText = `left:${Math.random()*100}%;width:${s}px;height:${s}px;background:${pCols[~~(Math.random()*pCols.length)]};animation-duration:${10+Math.random()*18}s;animation-delay:${Math.random()*14}s;box-shadow:0 0 ${s*4}px currentColor;`;
  pEl.appendChild(p);
}

// ‚îÄ‚îÄ DATA ‚îÄ‚îÄ
const ROMANS = ['I','II','III','IV','V','VI','VII','VIII','IX','X','XI','XII','XIII','XIV','XV'];
let chapters = [
  { id:1, num:0, title:"The Morning I Forgot My Name",
    content:`There are mornings when you wake up and the ceiling feels like a stranger. You blink once, twice, and for a fleeting second you don't know who you are. Not in a frightening way. In the quietest, most honest way imaginable.

I had one of those mornings last Tuesday. The light was coming in through the curtains the way it only does in autumn ‚Äî gold and thin and hesitant. The birds were trying very hard to be poetic about it.

I lay there, perfectly still, waiting for myself to return. And in that pause ‚Äî that three-second gap between sleep and person ‚Äî I think I understood something important.

We are not always who we were yesterday. And that is not a tragedy. That is, in fact, the whole point.

The name comes back. The to-do list comes back. The anxiety about that email you forgot to send comes back. But for three whole seconds, you were no one. And no one felt like freedom.`
  },
  { id:2, num:1, title:"Letters Never Sent",
    content:`I have a folder on my phone called "drafts" that has 47 unsent messages. To my mother, mostly. To a friend who moved away three years ago. To a version of myself from 2019 who desperately needed someone to tell her she was going to be okay.

I think writing letters you never send is one of the most honest things a person can do. There is no performance in it. No editing yourself for someone else's comfort. Just the raw, unpolished truth of what you actually meant to say.

The letter to my mother starts: I'm not angry anymore. I just miss who we were before we both became so careful around each other. I've rewritten it fourteen times. It gets more honest each time. I'll probably never send it. That's okay.

There's something sacred about words that exist only for you. They don't need to arrive anywhere. They just need to be true.`
  }
];
let nextId = 3;
let comments = [];
let nextCommentId = 1;
let currentChapterId = null;

// ‚îÄ‚îÄ OPEN BOOK ‚îÄ‚îÄ
window.onload = () => { buildTOC(); setTimeout(openBook, 1700); };

function openBook() {
  const cover = document.getElementById('coverWrap');
  cover.classList.add('open');
  setTimeout(() => {
    // Don't hide ‚Äî just make invisible so layout stays stable
    cover.style.visibility = 'hidden';
    cover.style.pointerEvents = 'none';
    const toc = document.getElementById('tocSpread');
    toc.classList.add('active');
    toc.style.opacity = '0'; toc.style.transition = 'opacity 0.5s';
    requestAnimationFrame(() => requestAnimationFrame(() => {
      toc.style.opacity = '1';
      revealTOC();
    }));
  }, 1950);
}

function revealTOC() {
  setTimeout(() => {
    document.querySelectorAll('.toc-row').forEach((el, i) => {
      setTimeout(() => el.classList.add('show'), i * 110);
    });
  }, 200);
}

// ‚îÄ‚îÄ TOC ‚îÄ‚îÄ
function buildTOC() {
  const list = document.getElementById('tocList');
  if (!chapters.length) {
    list.innerHTML = '<p style="font-family:Lora,serif;font-style:italic;color:rgba(0,0,0,0.3);text-align:center;padding:30px 0;font-size:0.85rem;">No chapters yet.</p>';
    return;
  }
  list.innerHTML = chapters.map(ch => `
    <div class="toc-row" onclick="openChapter(${ch.id})">
      <span class="toc-rnum">${ROMANS[ch.num]||ch.num+1}.</span>
      <span class="toc-rname">${ch.title}</span>
      <span class="toc-rdots"></span>
      <span class="toc-rpg">${ch.num*8+3}</span>
    </div>`).join('');
}

// ‚îÄ‚îÄ OPEN CHAPTER ‚îÄ‚îÄ
function openChapter(id) {
  currentChapterId = id;
  const ch = chapters.find(c => c.id === id);
  if (!ch) return;

  const paras = ch.content.split(/\n\n+/).filter(p => p.trim());
  const half  = Math.ceil(paras.length / 2);

  const makeHTML = (arr, dropCap) => arr.map((p, i) => {
    const cls = (i === 0 && dropCap) ? 'drop-cap' : '';
    return `<p class="${cls}" style="animation-delay:${i*0.1}s">${p.trim().replace(/\n/g,'<br>')}</p>`;
  }).join('');

  document.getElementById('rTitle').textContent       = ch.title;
  document.getElementById('rTextLeft').innerHTML      = makeHTML(paras.slice(0, half), true);
  document.getElementById('rTextRight').innerHTML     = makeHTML(paras.slice(half), false);

  // Smooth transition
  const toc = document.getElementById('tocSpread');
  toc.style.transition = 'opacity 0.35s';
  toc.style.opacity = '0';
  setTimeout(() => {
    toc.classList.remove('active');
    const rs = document.getElementById('readSpread');
    rs.classList.add('active');
    rs.style.opacity = '0'; rs.style.transition = 'opacity 0.4s';
    requestAnimationFrame(() => requestAnimationFrame(() => rs.style.opacity = '1'));
  }, 360);
}

// ‚îÄ‚îÄ BACK TO TOC ‚îÄ‚îÄ
function backToTOC() {
  const rs = document.getElementById('readSpread');
  rs.style.transition = 'opacity 0.35s'; rs.style.opacity = '0';
  setTimeout(() => {
    rs.classList.remove('active');
    buildTOC();
    const toc = document.getElementById('tocSpread');
    toc.classList.add('active');
    toc.style.opacity = '0'; toc.style.transition = 'opacity 0.4s';
    requestAnimationFrame(() => requestAnimationFrame(() => {
      toc.style.opacity = '1';
      revealTOC();
    }));
  }, 360);
}

// ‚îÄ‚îÄ COMMENT ‚îÄ‚îÄ
function submitComment() {
  const name = document.getElementById('cName').value.trim() || 'Anonymous';
  const text = document.getElementById('cText').value.trim();
  if (!text) return;
  const ch = chapters.find(c => c.id === currentChapterId);
  comments.push({
    id: nextCommentId++, name, text,
    chapterId: currentChapterId,
    chapterTitle: ch ? ch.title : 'General',
    date: new Date().toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'})
  });
  spawnConfetti();
  document.getElementById('cForm').style.display = 'none';
  document.getElementById('cTy').classList.add('show');
  setTimeout(() => {
    document.getElementById('commentOverlay').classList.remove('active');
    document.getElementById('cForm').style.display = 'block';
    document.getElementById('cTy').classList.remove('show');
    document.getElementById('cName').value = '';
    document.getElementById('cText').value = '';
    returnToCover();
  }, 2600);
}

function spawnConfetti() {
  const cols = ['#c9972a','#e8b84b','#f5d67a','#8b6010','#d4a017'];
  for (let i = 0; i < 30; i++) {
    const c = document.createElement('div');
    c.style.cssText = `position:fixed;left:${15+Math.random()*70}%;top:20%;width:${6+Math.random()*9}px;height:${6+Math.random()*9}px;background:${cols[~~(Math.random()*cols.length)]};border-radius:${Math.random()>.5?'50%':'2px'};animation:confFall ${1.2+Math.random()*.9}s ease-in forwards;animation-delay:${Math.random()*.4}s;pointer-events:none;z-index:500;`;
    document.body.appendChild(c);
    setTimeout(() => c.remove(), 2500);
  }
}

function returnToCover() {
  const toc = document.getElementById('tocSpread');
  const rs  = document.getElementById('readSpread');
  toc.style.opacity = '0'; rs.style.opacity = '0';
  setTimeout(() => {
    toc.classList.remove('active'); rs.classList.remove('active');
    const cover = document.getElementById('coverWrap');
    cover.style.visibility = ''; cover.style.pointerEvents = '';
    cover.classList.remove('open');
    cover.style.transition = 'none'; void cover.offsetWidth; cover.style.transition = '';
    setTimeout(openBook, 2400);
  }, 400);
}

// ‚îÄ‚îÄ SECRET SHORTCUT ‚îÄ‚îÄ
let keyBuffer = '';
document.addEventListener('keydown', e => {
  const tag = document.activeElement.tagName;
  if (tag === 'INPUT' || tag === 'TEXTAREA') return;
  keyBuffer += e.key.toLowerCase();
  if (keyBuffer.length > 6) keyBuffer = keyBuffer.slice(-6);
  if (keyBuffer === 'charmi') { keyBuffer = ''; openWriter(); }
});

// ‚îÄ‚îÄ WRITER ‚îÄ‚îÄ
function openWriter() {
  buildChapterCards(); buildComments();
  document.getElementById('writerPanel').classList.add('active');
  const flash = document.getElementById('secretFlash');
  flash.classList.add('show');
  setTimeout(() => flash.classList.remove('show'), 2200);
}
function closeWriter() { document.getElementById('writerPanel').classList.remove('active'); }
document.getElementById('writerPanel').addEventListener('click', e => {
  if (e.target === document.getElementById('writerPanel')) closeWriter();
});

function switchTab(name, btn) {
  document.querySelectorAll('.w-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.w-panel').forEach(p => p.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('tab-'+name).classList.add('active');
  if (name === 'chapters') buildChapterCards();
  if (name === 'comments') buildComments();
}

function publishChapter() {
  const title   = document.getElementById('wTitle').value.trim();
  const content = document.getElementById('wContent').value.trim();
  if (!title || !content) { showToast('Add a title and content first ‚ú¶'); return; }
  const nv  = document.getElementById('wNum').value;
  const num = nv ? Math.max(0, parseInt(nv)-1) : chapters.length;
  chapters.push({ id: nextId++, title, content, num });
  chapters.sort((a,b) => a.num - b.num);
  document.getElementById('wTitle').value = '';
  document.getElementById('wContent').value = '';
  document.getElementById('wNum').value = '';
  buildTOC(); buildChapterCards();
  showToast('Published to Diary ‚ú¶');
}

function buildChapterCards() {
  const el = document.getElementById('wCards');
  if (!chapters.length) { el.innerHTML = '<p class="w-empty">No chapters yet. Write your first entry!</p>'; return; }
  el.innerHTML = chapters.map(ch => `
    <div class="w-ccard">
      <div>
        <div class="w-ccard-title">${ch.title}</div>
        <div class="w-ccard-meta">Chapter ${ROMANS[ch.num]||ch.num+1} ¬∑ ${ch.content.trim().split(/\s+/).length} words</div>
      </div>
      <div class="w-actions">
        <button class="w-act ed" onclick="editChapter(${ch.id})">Edit</button>
        <button class="w-act dl" onclick="deleteChapter(${ch.id})">Delete</button>
      </div>
    </div>`).join('');
}

function editChapter(id) {
  const ch = chapters.find(c => c.id === id);
  if (!ch) return;
  chapters = chapters.filter(c => c.id !== id);
  document.getElementById('wTitle').value   = ch.title;
  document.getElementById('wContent').value = ch.content;
  document.getElementById('wNum').value     = ch.num + 1;
  document.querySelectorAll('.w-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.w-panel').forEach(p => p.classList.remove('active'));
  document.getElementById('tab-btn-write').classList.add('active');
  document.getElementById('tab-write').classList.add('active');
  showToast('Loaded for editing ‚ú¶');
}

function deleteChapter(id) {
  chapters = chapters.filter(c => c.id !== id);
  buildTOC(); buildChapterCards();
  showToast('Chapter removed ‚ú¶');
}

function buildComments() {
  const el = document.getElementById('wComments');
  if (!comments.length) {
    el.innerHTML = '<p class="w-empty">No comments yet. They\'ll appear here once readers leave their thoughts.</p>';
    return;
  }
  el.innerHTML = comments.slice().reverse().map(c => `
    <div class="w-comment-card" id="cmnt-${c.id}">
      <div class="w-comment-meta">
        <span class="w-comment-author">‚ú¶ ${c.name}</span>
        <span class="w-comment-chapter">${c.chapterTitle} ¬∑ ${c.date}</span>
      </div>
      <div class="w-comment-text">"${c.text}"</div>
      <div class="w-comment-footer">
        <button class="w-act dl" onclick="deleteComment(${c.id})">Delete</button>
      </div>
    </div>`).join('');
}

function deleteComment(id) {
  const card = document.getElementById('cmnt-'+id);
  if (card) { card.style.opacity = '0'; card.style.transition = 'opacity 0.3s'; }
  setTimeout(() => { comments = comments.filter(c => c.id !== id); buildComments(); }, 320);
  showToast('Comment removed ‚ú¶');
}

// ‚îÄ‚îÄ TEXT TOOLS ‚îÄ‚îÄ
function wWrap(a,b) {
  const ta = document.getElementById('wContent');
  const s = ta.selectionStart, e = ta.selectionEnd;
  ta.value = ta.value.substring(0,s)+a+(ta.value.substring(s,e)||'text')+b+ta.value.substring(e);
  ta.focus();
}
function wBreak() {
  const ta = document.getElementById('wContent'), s = ta.selectionStart;
  ta.value = ta.value.substring(0,s)+'\n\n'+ta.value.substring(s);
  ta.selectionStart = ta.selectionEnd = s+2; ta.focus();
}
function wIns(str) {
  const ta = document.getElementById('wContent'), s = ta.selectionStart;
  ta.value = ta.value.substring(0,s)+str+ta.value.substring(s);
  ta.selectionStart = ta.selectionEnd = s+str.length; ta.focus();
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2600);
}
</script>
</body>
</html>
